<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <FSharpHome1>$(MSBuildExtensionsPath32)\..\Microsoft SDKs\F#\3.0\Framework\v4.0</FSharpHome1>
    <FSharpHome2>$(MSBuildExtensionsPath32)\..\Microsoft F#\v4.0\</FSharpHome2>
    <FSharpHome3>$(MSBuildExtensionsPath32)\FSharp\1.0</FSharpHome3>
    <FSharpHome Condition="Exists('$(FSharpHome1)') AND '$(FSharpHome)' == ''">$(FSharpHome1)</FSharpHome>
    <FSharpHome Condition="Exists('$(FSharpHome2)') AND '$(FSharpHome)' == ''">$(FSharpHome2)</FSharpHome>
    <FSharpHome Condition="Exists('$(FSharpHome3)') AND '$(FSharpHome)' == ''">$(FSharpHome3)</FSharpHome>
  </PropertyGroup>
  <UsingTask TaskName="RunNetProgram" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <Program ParameterType="System.String" Required="true" />
      <Arguments ParameterType="System.String[]" Required="true" />
      <WorkingDirectory ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System" />
      <Using Namespace="System.IO" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
            Console.Error.WriteLine(Arguments.Length);
            Console.Error.WriteLine(Arguments[0]);
            Console.Error.WriteLine(Arguments[1]);
            var dir = Environment.CurrentDirectory;
            Environment.CurrentDirectory = WorkingDirectory;
            try
            {
              var setup = new AppDomainSetup();
              setup.ApplicationBase = Path.GetDirectoryName(Program);
              var domain = AppDomain.CreateDomain("Slave", null, setup);
              try { domain.ExecuteAssembly(Program, Arguments); }
              finally { AppDomain.Unload(domain); }
            }
            finally
            {
              Environment.CurrentDirectory = dir;
            }
        ]]>
      </Code>
    </Task>
  </UsingTask>
</Project>
